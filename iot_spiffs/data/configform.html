<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'/>
    <title>Configuration</title>
</head>
<body>
Configure Settings
<br><br>
<!--<form method="POST" action="/submitconfig">-->
WiFi: <br>
<input type="text" id="wifi" name="wifi" placeholder="WiFi name" disabled="true">
<br>
Password: <br>
<input type="text" id="password" name="password" placeholder="WiFi password" disabled="true">
<br>
Subnet: <br>
<input type="number" id="subnet" name="subnet" placeholder="Subnet Id" min="1" max="255" disabled="true">
<br>
Host: <br>
<input type="number" id="host" name="host" placeholder="Host Id" min="1" max="255" disabled="true">
<br>
Gateway & DNS host: <br>
<input type="number" id="gatewaydnshost" name="gatewaydnshost" placeholder="Host of gateway and dns" min="1" max="255" disabled="true">
<br>
Machine Id: <br>
<input type="text" id="mId" name="mId" placeholder="MCD Id" disabled="true">
<br><br>
<button id="submitbtn" onclick="submitConfig()" hidden="true">Submit</button>
<script>
	function authenticate(user, pass) {
		var formData = new FormData();
		formData.append("username", user);
		formData.append("password", pass);
		
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				const resjson = JSON.parse(xhr.response);
				
				if (resjson.success) {
					document.getElementById("submitbtn").hidden = false;
					document.getElementById("gatewaydnshost").disabled = false;
					document.getElementById("host").disabled = false;
					document.getElementById("subnet").disabled = false;
					document.getElementById("password").disabled = false;
					document.getElementById("wifi").disabled = false;
					document.getElementById("mId").disabled = false;
				} else {
					location.assign("/errorpage");
				}
			}
		};

		xhr.onloadend = function() {
			if (xhr.status !== 200) {
				console.log('error '+this.status);
			}
		};

		xhr.onerror = function(error) {
			console.log('Network Error');
			console.log(error);
		};

		xhr.open('POST', 'authenticate', true);
		xhr.send(formData);
	}

	let user = prompt("Enter username:", "");
	let pass;
	
	if (user === null || user === "") {
		location.assign("/errorpage");
	} else {
		pass = prompt("Enter password:", "");
		
		if (pass === null || pass === "") {
			location.assign("/errorpage");
		} else {
			//	authenticate here
			authenticate(user, pass);
		}
	}

	function submitConfig() {
		var wifi = document.getElementById("wifi").value;
		var pass = document.getElementById("password").value;
		var subnet = document.getElementById("subnet").value;
		var host = document.getElementById("host").value;
		var gatewaydnshost = document.getElementById("gatewaydnshost").value;
		var mid = document.getElementById("mId").value;
		
		if (wifi === null || wifi === "") {
			alert("Please enter wifi");
			return;
		}
		
		if (pass === null || pass === "") {
			alert("Please enter password");
			return;
		}
		
		if (subnet === null || subnet === "") {
			alert("Please enter subnet");
			return;
		} else {
			try {
				var subnetnum = parseInt(subnet);
				if (subnetnum < 1 || subnetnum > 255)  {
					alert("Subnet must be between 1 - 255");
					return;
				}
			} catch (err) {
				alert("Invalid subnet");
				return;
			}
		}
		
		if (host === null || host === "") {
			alert("Please enter host");
			return;
		} else {
			try {
				var hostnum = parseInt(host);
				if (hostnum < 1 || hostnum > 255)  {
					alert("host must be between 1 - 255");
					return;
				}
			} catch (err) {
				alert("Invalid host");
				return;
			}
		}
		
		if (gatewaydnshost === null || gatewaydnshost === "") {
			alert("Please enter gatewaydnshost");
			return;
		} else {
			try {
				var gatewaydnshostnum = parseInt(gatewaydnshost);
				if (gatewaydnshostnum < 1 || gatewaydnshostnum > 255)  {
					alert("gatewaydnshostnum must be between 1 - 255");
					return;
				}
			} catch (err) {
				alert("Invalid gatewaydnshost");
				return;
			}
		}
		
		if (mid === null || mid === "") {
			alert("Please enter mid");
			return;
		}
		
		var formData = new FormData();
		formData.append("wifi", wifi);
		formData.append("password", pass);
		formData.append("subnet", subnet);
		formData.append("host", host);
		formData.append("gatewaydnshost", gatewaydnshost);
		formData.append("mId", mid);
		
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				const resjson = JSON.parse(xhr.response);
				alert(resjson.success ? "Configuration has been updated" : resjson.reason);
				location.reload(); 
			}
		};

		xhr.onloadend = function() {
			if (xhr.status != 200) {
				console.log('error '+this.status);
			}
		};

		xhr.onerror = function(error) {
			console.log('Network Error');
			console.log(error);
		};

		xhr.open('POST', 'submitconfig', true);
		xhr.send(formData);
	}
</script>
</body>
</html>